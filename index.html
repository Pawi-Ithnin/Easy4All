const firebaseConfig = { databaseURL: "https://tanda-x-pro-default-rtdb.asia-southeast1.firebasedatabase.app/" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const wordImages = {
    "kami": "https://i.ibb.co/2BQ4Zyw/Kami-b14a9c807d6417a26758-1.jpg",
    "saya": "https://i.ibb.co/tTYPQ2YH/Saya-308cf649158d30e78273.jpg",
    "makan": "https://i.ibb.co/pd6WB8L/Makan-Makanan-358171f7a0d456b53998.jpg",
    "mandi": "https://i.ibb.co/RT8bLtZ/Mandi-36a248a7c1e9603e8ad9.jpg"
};

const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;

if (Recognition) {
    rec = new Recognition();
    rec.lang = 'ms-MY';
    rec.continuous = true;

    rec.onresult = (e) => {
        const transcript = e.results[e.results.length - 1][0].transcript.toLowerCase().trim();
        document.getElementById('transcriptDisplay').innerText = `"${transcript}"`;
        
        const words = transcript.split(" ");
        let found = false;

        for (let i = words.length - 1; i >= 0; i--) {
            let cleanWord = words[i].replace(/[^\w]/g, '');
            if (wordImages[cleanWord]) {
                document.getElementById('signImage').src = wordImages[cleanWord];
                document.getElementById('output').innerText = cleanWord.toUpperCase();
                found = true;
                break; 
            }
        }
        if (!found) {
            document.getElementById('output').innerText = "Tiada Padanan";
            document.getElementById('signImage').src = "https://via.placeholder.com/350?text=Tiada+Padanan";
        }
    };
}

// UI HANDLERS
document.addEventListener('DOMContentLoaded', () => {
    if(localStorage.getItem('tandaX_logged') === 'true') bukaAplikasi();

    document.getElementById('btnStart').onclick = () => { rec && rec.start(); };
    document.getElementById('btnStop').onclick = () => { rec && rec.stop(); };
    document.getElementById('btnYT').onclick = () => { document.getElementById('youtubeSection').style.display = "block"; };

    document.getElementById('btnLoad').onclick = () => {
        const url = document.getElementById('youtubeUrl').value.trim();
        const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(regex);
        if (match && match[1]) {
            document.getElementById('player').innerHTML = `<iframe src="https://www.youtube.com/embed/${match[1]}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
        }
    };
});

window.prosesLogin = () => {
    localStorage.setItem('tandaX_logged', 'true');
    bukaAplikasi();
};

function bukaAplikasi() {
    document.getElementById('pay-screen').style.display = 'none';
    document.getElementById('mainAppSection').style.display = 'block';
}

window.logKeluar = () => { localStorage.clear(); location.reload(); };

// CNY Animation
setInterval(() => {
    const icon = document.createElement('div');
    icon.className = 'cny-icon';
    icon.innerText = ['ðŸŠ', 'ðŸ§§', 'ðŸ®'][Math.floor(Math.random()*3)];
    icon.style.left = Math.random() * 100 + "vw";
    icon.style.animation = `fall ${Math.random()*3 + 4}s linear forwards`;
    document.body.appendChild(icon);
    setTimeout(() => icon.remove(), 5000);
}, 1000);
